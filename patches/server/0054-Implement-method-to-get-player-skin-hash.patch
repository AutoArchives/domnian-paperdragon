From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Fri, 12 Jul 2019 03:48:22 -0400
Subject: [PATCH] Implement method to get player skin hash


diff --git a/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
index 204e4b0be7f6ae2d4f7acf28e39b33748d5b4db2..77b514e6bc0a945701cc3ee9e7905395555474b7 100644
--- a/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
+++ b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
@@ -24,6 +24,9 @@
 package com.domnian.paperdragon.api;
 
 import com.destroystokyo.paper.MaterialTags;
+import com.destroystokyo.paper.profile.ProfileProperty;
+import com.google.gson.Gson;
+import com.google.gson.JsonObject;
 import net.minecraft.core.BlockPos;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.ListTag;
@@ -37,10 +40,14 @@ import net.minecraft.world.level.saveddata.maps.MapItemSavedData;
 import org.bukkit.Location;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.craftbukkit.util.CraftMagicNumbers;
+import org.bukkit.entity.Player;
 import org.jetbrains.annotations.NotNull;
 
+import java.util.Optional;
 import java.util.ArrayList;
+import java.util.Base64;
 import java.util.List;
+import java.util.Set;
 
 public class CraftDAPI_Misc implements DAPI_Misc {
 
@@ -113,4 +120,17 @@ public class CraftDAPI_Misc implements DAPI_Misc {
         return null;
     }
 
+    @Override
+    public String getSkinHash(@NotNull Player player) {
+        if (!player.getPlayerProfile().hasTextures()) return null;
+        Set<ProfileProperty> properties = player.getPlayerProfile().getProperties();
+        properties.removeIf(p -> !p.getName().equalsIgnoreCase("textures"));
+        Optional<ProfileProperty> opt = properties.stream().findFirst();
+        if (opt.isEmpty()) return null;
+        String encoded = opt.get().getValue();
+        JsonObject decoded = new Gson().fromJson(new String(Base64.getDecoder().decode(encoded)), JsonObject.class);
+        String skinUrl = decoded.getAsJsonObject("textures").getAsJsonObject("SKIN").get("url").getAsString();
+        return skinUrl.substring(38);
+    }
+
 }
