From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Fri, 12 Jul 2019 03:48:22 -0400
Subject: [PATCH] Implement method to get player skin hash


diff --git a/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
index c15d72c72eea6d63c53250b4c72807ed0181e24e..dda6cc51eb6611c9b14f1466581565007a06085c 100644
--- a/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
+++ b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Misc.java
@@ -24,15 +24,21 @@
 package com.domnian.paperdragon.api;
 
 import com.destroystokyo.paper.MaterialTags;
+import com.destroystokyo.paper.profile.ProfileProperty;
+import com.google.gson.Gson;
+import com.google.gson.JsonObject;
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.ListTag;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.craftbukkit.util.CraftMagicNumbers;
+import org.bukkit.entity.Player;
 import org.jetbrains.annotations.NotNull;
 
 import java.util.ArrayList;
+import java.util.Base64;
 import java.util.List;
+import java.util.Set;
 
 public class CraftDAPI_Misc implements DAPI_Misc {
 
@@ -62,6 +68,17 @@ public class CraftDAPI_Misc implements DAPI_Misc {
         return items;
     }
 
+    @Override
+    public String getSkinHash(@NotNull Player player) {
+        if (!player.getPlayerProfile().hasTextures()) return null;
+        Set<ProfileProperty> properties = player.getPlayerProfile().getProperties();
+        properties.removeIf(p -> !p.getName().equalsIgnoreCase("textures"));
+        String encoded = properties.stream().findFirst().get().getValue();
+        JsonObject decoded = new Gson().fromJson(new String(Base64.getDecoder().decode(encoded)), JsonObject.class);
+        String skinUrl = decoded.getAsJsonObject("textures").getAsJsonObject("SKIN").get("url").getAsString();
+        return skinUrl.substring(38);
+    }
+
     private static ListTag getNBTItems(org.bukkit.inventory.ItemStack shulker) {
         if (shulker == null) {
             throw new NullPointerException("Itemstack can not be null");
