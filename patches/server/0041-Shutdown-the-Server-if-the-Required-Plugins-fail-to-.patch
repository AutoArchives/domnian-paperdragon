From a1edf8cc072f7f4e65aed8c48985d7b3dabeed1e Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Mon, 19 Mar 2018 02:23:21 -0400
Subject: [PATCH] Shutdown the Server if the Required Plugins fail to Load

Based on EmpireCraft Server Patch #76 (https://git.io/vx3xr)
---
 .../com/domnian/paperdragon/DragonConfig.java |  6 ++++++
 .../net/minecraft/server/MinecraftServer.java | 19 +++++++++++++++++++
 2 files changed, 25 insertions(+)

diff --git a/src/main/java/com/domnian/paperdragon/DragonConfig.java b/src/main/java/com/domnian/paperdragon/DragonConfig.java
index 146c8c3a6..8fee676b2 100644
--- a/src/main/java/com/domnian/paperdragon/DragonConfig.java
+++ b/src/main/java/com/domnian/paperdragon/DragonConfig.java
@@ -13,6 +13,7 @@ import java.io.IOException;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.lang.reflect.Modifier;
+import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
@@ -175,4 +176,9 @@ public class DragonConfig {
         broadcastAdvancementsToServer = getBoolean("settings.broadcast-advancements-to-server", false);
     }
 
+    public static List<String> requiredPlugins = new ArrayList<>();
+    private static void requiredPlugins() {
+        requiredPlugins = getList("settings.required-plugins", requiredPlugins);
+    }
+
 }
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index d5fdb670a..babf1969a 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -587,6 +587,25 @@ public abstract class MinecraftServer implements IAsyncTaskHandler, IMojangStati
         this.w = null;
         this.x = 0;
         this.server.enablePlugins(org.bukkit.plugin.PluginLoadOrder.POSTWORLD); // CraftBukkit
+        // PaperDragon start - Shutdown if a Required Plugin Fails to Load
+        List<String> failed = new ArrayList<>();
+        com.domnian.paperdragon.DragonConfig.requiredPlugins.forEach(pluginName -> {
+            org.bukkit.plugin.Plugin required = server.getPluginManager().getPlugin(pluginName);
+            if (required == null || !required.isEnabled()) failed.add(pluginName);
+        });
+        if (failed.size() > 0) {
+            String names = org.apache.commons.lang.StringUtils.join(failed.toArray(new String[failed.size()]), ", ");
+            if (failed.size() == 2) {
+                names = failed.get(0) + " and " + failed.get(1);
+            } else if (failed.size() > 2) {
+                String p1 = names.substring(0, names.lastIndexOf(",") + 1);
+                String p2 = names.substring(names.lastIndexOf(",") + 1);
+                names = p1 + " and" + p2;
+            }
+            System.err.println("CRITICAL - " + names + " failed to load!");
+            server.shutdown();
+        }
+        // PaperDragon end
     }
 
     protected void saveChunks(boolean flag) {
-- 
2.18.0

