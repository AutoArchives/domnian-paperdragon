From a5dcace8b2050f5129be5d61ff71b6d5f697a5ad Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Thu, 3 May 2018 21:42:07 -0400
Subject: [PATCH] Implement Enhanced Death Event

---
 src/main/java/com/domnian/paperdragon/PDEventFactory.java | 9 +++++++++
 src/main/java/net/minecraft/server/EntityPlayer.java      | 1 +
 2 files changed, 10 insertions(+)

diff --git a/src/main/java/com/domnian/paperdragon/PDEventFactory.java b/src/main/java/com/domnian/paperdragon/PDEventFactory.java
index b9d2de8b..9b63db3c 100644
--- a/src/main/java/com/domnian/paperdragon/PDEventFactory.java
+++ b/src/main/java/com/domnian/paperdragon/PDEventFactory.java
@@ -1,16 +1,20 @@
 package com.domnian.paperdragon;
 
+import com.domnian.paperdragon.events.EnhancedPlayerDeathEvent;
 import com.domnian.paperdragon.events.PlayerHitPlayerEvent;
 import com.domnian.paperdragon.events.ServerShutdownEvent;
 import net.minecraft.server.BlockPosition;
 import net.minecraft.server.Entity;
 import net.minecraft.server.EntityPlayer;
+import net.minecraft.server.IChatBaseComponent;
+import net.minecraft.server.ChatMessage;
 import org.bukkit.Bukkit;
 import org.bukkit.block.Block;
 import org.bukkit.craftbukkit.CraftWorld;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
 import org.bukkit.entity.Player;
 import org.bukkit.event.block.SpongeAbsorbEvent;
+import org.bukkit.event.entity.PlayerDeathEvent;
 import org.bukkit.inventory.ItemStack;
 
 public class PDEventFactory {
@@ -38,4 +42,9 @@ public class PDEventFactory {
         new ServerShutdownEvent(isRestarting).callEvent();
     }
 
+    public static void enhanceDeathEvent(PlayerDeathEvent parent, IChatBaseComponent component) {
+        String deathKey = (component instanceof ChatMessage) ? ((ChatMessage) component).i() : "death.attack.generic";
+        new EnhancedPlayerDeathEvent(parent, deathKey).callEvent();
+    }
+
 }
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index e261a777..b5ddee8e 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -495,6 +495,7 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
 
         String deathmessage = chatmessage.toPlainText();
         org.bukkit.event.entity.PlayerDeathEvent event = CraftEventFactory.callPlayerDeathEvent(this, loot, deathmessage, keepInventory);
+        com.domnian.paperdragon.PDEventFactory.enhanceDeathEvent(event, chatmessage); // PaperDragon - Enchanced Death Event
 
         String deathMessage = event.getDeathMessage();
 
-- 
2.16.2

