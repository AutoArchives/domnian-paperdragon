From 3ff786a71d94f48950af4c8401d683b7f48679f5 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Wed, 27 Feb 2013 23:27:45 -0500
Subject: [PATCH] Hidden Item Meta

This adds the ability to store hidden metadata in item lore.

Simply set a line to "&&::META" and every blank line before, that line, and every line after will be hidden from view on the client.

for example, you can set &&::META on line 20, and there will not be 19 blank lines before it.
Then you can store Data on 21+

Also adds a &&::SHINY tag to send a fake enchantment aura if it does not exists.
Must be set before META
---
 .../com/domnian/paperdragon/DragonConfig.java |  6 ++
 .../paperdragon/api/HiddenItemMeta.java       | 93 +++++++++++++++++++
 .../java/net/minecraft/server/ItemStack.java  |  2 +-
 .../server/PacketDataSerializer.java          |  2 +
 4 files changed, 102 insertions(+), 1 deletion(-)
 create mode 100644 src/main/java/com/domnian/paperdragon/api/HiddenItemMeta.java

diff --git a/src/main/java/com/domnian/paperdragon/DragonConfig.java b/src/main/java/com/domnian/paperdragon/DragonConfig.java
index 6ef5dd625..6d129abae 100644
--- a/src/main/java/com/domnian/paperdragon/DragonConfig.java
+++ b/src/main/java/com/domnian/paperdragon/DragonConfig.java
@@ -156,6 +156,12 @@ public class DragonConfig {
         return config.getString(path, config.getString(path));
     }
 
+    public static String hiddenItemMetaTagMeta;
+    public static String hiddenItemMetaTagShiny;
+    private static void hiddenItemMetaTags() {
+        hiddenItemMetaTagMeta = getString("settings.hidden-item-meta.meta-tag", "&&::META");
+        hiddenItemMetaTagShiny = getString("settings.hidden-item-meta.shiny-tag", "&&::SHINY");
+    }
     // TODO Add New Settings!! :D
 
 }
diff --git a/src/main/java/com/domnian/paperdragon/api/HiddenItemMeta.java b/src/main/java/com/domnian/paperdragon/api/HiddenItemMeta.java
new file mode 100644
index 000000000..ff87756a5
--- /dev/null
+++ b/src/main/java/com/domnian/paperdragon/api/HiddenItemMeta.java
@@ -0,0 +1,93 @@
+package com.domnian.paperdragon.api;
+
+import com.domnian.paperdragon.DragonConfig;
+import net.minecraft.server.NBTTagCompound;
+import net.minecraft.server.NBTTagList;
+import net.minecraft.server.NBTTagString;
+
+public class HiddenItemMeta {
+
+    public static NBTTagCompound filterItemLore(NBTTagCompound nbttagcompound, boolean storeOriginal) {
+        if (nbttagcompound != null && nbttagcompound.hasKey("display")) {
+            NBTTagCompound display = nbttagcompound.getCompound("display");
+            if (display.hasKey("Lore")) {
+                NBTTagList lore = display.getList("Lore", 8);
+                int lastLine = 0;
+                boolean hasSpecial = false;
+                boolean hasShiny = false;
+                for (int i = 0; i < lore.size(); i++) {
+                    String line = lore.getString(i);
+
+                    if (line.equals(DragonConfig.hiddenItemMetaTagMeta)) {
+                        hasSpecial = true;
+                        break;
+                    } else if (!line.isEmpty()) {
+                        if (line.equals(DragonConfig.hiddenItemMetaTagShiny)) {
+                            hasShiny = true;
+                            hasSpecial = true;
+                            break;
+                        } else {
+                            lastLine = i + 1;
+                        }
+                    }
+                }
+                if (hasSpecial) {
+                    NBTTagList newlore = new NBTTagList();
+                    for (int x = 0; x < lastLine; x++) {
+                        newlore.add(new NBTTagString(lore.getString(x)));
+                    }
+
+                    nbttagcompound = (NBTTagCompound) nbttagcompound.clone();
+                    if (hasShiny && !nbttagcompound.hasKey("ench")) {
+                        NBTTagList nbtbase = new NBTTagList();
+                        NBTTagCompound enchant = new NBTTagCompound();
+                        enchant.setShort("id", (short) 1);
+                        enchant.setShort("lvl", (short) 1);
+                        nbtbase.add(enchant);
+                        nbttagcompound.set("ench", nbtbase);
+                        int flags = 1;
+                        if (nbttagcompound.hasKey("HideFlags")) {
+                            flags = nbttagcompound.getInt("HideFlags");
+                            nbttagcompound.setInt("HideFlagsOrig", flags);
+                            flags &= 1;
+                        } else {
+                            nbttagcompound.remove("HideFlagsOrig");
+                        }
+                        nbttagcompound.setInt("HideFlags", flags);
+                        nbttagcompound.setInt("fakeench", 1);
+                    }
+                    display = nbttagcompound.getCompound("display");
+                    display.set("Lore", newlore);
+                    if (storeOriginal) {
+                        display.set("OriginalLore", lore);
+                    }
+                }
+            }
+        }
+        return nbttagcompound;
+    }
+
+    public static NBTTagCompound restoreItemLore(NBTTagCompound tag) {
+        if (tag.hasKey("display")) {
+            NBTTagCompound display = tag.getCompound("display");
+            if (display.hasKey("OriginalLore")) {
+                display.set("Lore", display.getList("OriginalLore", 8));
+                display.remove("OriginalLore");
+            }
+        }
+        // If shiny was used
+        if (tag.hasKey("fakeench")) {
+            int orig = tag.getInt("HideFlagsOrig");
+            if (tag.hasKey("HideFlagsOrig") && orig != 1) {
+                tag.setInt("HideFlags", orig);
+            } else {
+                tag.remove("HideFlags");
+            }
+            tag.remove("fakeench");
+            tag.remove("ench");
+            tag.remove("HideFlagsOrig");
+        }
+        return tag;
+    }
+
+}
diff --git a/src/main/java/net/minecraft/server/ItemStack.java b/src/main/java/net/minecraft/server/ItemStack.java
index 94dcb9494..9f9b0a6ea 100644
--- a/src/main/java/net/minecraft/server/ItemStack.java
+++ b/src/main/java/net/minecraft/server/ItemStack.java
@@ -52,7 +52,7 @@ public final class ItemStack {
     private int e;
     @Deprecated
     private Item item;
-    private NBTTagCompound tag;
+    public NBTTagCompound tag; // PaperDragon - Hidden Item Meta API
     private boolean h;
     private EntityItemFrame i;
     private ShapeDetectorBlock j;
diff --git a/src/main/java/net/minecraft/server/PacketDataSerializer.java b/src/main/java/net/minecraft/server/PacketDataSerializer.java
index d04afceb7..1a11aa67e 100644
--- a/src/main/java/net/minecraft/server/PacketDataSerializer.java
+++ b/src/main/java/net/minecraft/server/PacketDataSerializer.java
@@ -251,6 +251,7 @@ public class PacketDataSerializer extends ByteBuf {
                 CraftItemStack.setItemMeta(itemstack, CraftItemStack.getItemMeta(itemstack));
                 // Spigot end
                 nbttagcompound = itemstack.getTag();
+                nbttagcompound = com.domnian.paperdragon.api.HiddenItemMeta.filterItemLore(nbttagcompound, true); // PaperDragon - Hidden Item Meta API
             }
 
             this.a(nbttagcompound);
@@ -271,6 +272,7 @@ public class PacketDataSerializer extends ByteBuf {
             itemstack.setTag(this.j());
             // CraftBukkit start
             if (itemstack.getTag() != null) {
+                itemstack.tag = com.domnian.paperdragon.api.HiddenItemMeta.restoreItemLore(itemstack.tag); // PaperDragon - Hidden Item Meta API
                 CraftItemStack.setItemMeta(itemstack, CraftItemStack.getItemMeta(itemstack));
             }
             // CraftBukkit end
-- 
2.18.0

