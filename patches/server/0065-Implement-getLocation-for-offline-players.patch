From de0052965eb936fdc07baf60fbb3f36bf9e2be7d Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Sun, 12 Jan 2020 19:50:51 -0500
Subject: [PATCH] Implement getLocation() for offline players

---
 .../net/minecraft/server/PlayerConnection.java   |  1 +
 .../bukkit/craftbukkit/CraftOfflinePlayer.java   | 16 ++++++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 456d0c043..3d6323d8b 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -892,6 +892,7 @@ public class PlayerConnection implements PacketListenerPlayIn {
 
             if (entity != null) {
                 NBTTagCompound nbttagcompound = entity.save(new NBTTagCompound());
+                nbttagcompound.setString("Dragon.DisconnectWorld", this.player.getWorld().getWorldData().getName()); // PaparDragon - save world disconnected from
 
                 this.player.playerConnection.sendPacket(new PacketPlayOutNBTQuery(packetplayinentitynbtquery.b(), nbttagcompound));
             }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
index 3824180ee..be7bf2894 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
@@ -341,4 +341,20 @@ public class CraftOfflinePlayer implements OfflinePlayer, ConfigurationSerializa
     public void removeMetadata(String metadataKey, Plugin plugin) {
         server.getPlayerMetadata().removeMetadata(this, metadataKey, plugin);
     }
+
+    // PaperDragon start
+    public Location getLocation() {
+        NBTTagCompound data = getData();
+        net.minecraft.server.NBTTagList pos = data.getList("Pos", 6); // 6 = NBTTagDouble
+        net.minecraft.server.NBTTagList rot = data.getList("Rotation", 5); // 5 = NBTTagFloat
+        String worldName = data.hasKeyOfType("Dragon.DisconnectWorld", 8) ? data.getString("Dragon.DisconnectWorld") : server.getHandle().getServer().getWorld();
+        return new Location(
+                Bukkit.getWorld(worldName), // World
+                pos.getDoubleAt(0), pos.getDoubleAt(1), pos.getDoubleAt(2), // X, Y, Z
+                ((net.minecraft.server.NBTTagFloat) rot.get(0)).asFloat(), // Yaw
+                ((net.minecraft.server.NBTTagFloat) rot.get(1)).asFloat() // Pitch
+        );
+    }
+    // PaperDragon end
+
 }
-- 
2.20.1.windows.1

