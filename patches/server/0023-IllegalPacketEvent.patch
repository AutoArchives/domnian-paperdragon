From 81f1eb7e083af9416fdb69d6b9c3e6e1676bbbb4 Mon Sep 17 00:00:00 2001
From: Aikar <aikar@aikar.co>
Date: Thu, 23 Jun 2016 23:33:57 -0400
Subject: [PATCH] IllegalPacketEvent

Fired for invalid data from players that usually represents hacking
---
 .../net/minecraft/server/PlayerConnection.java     | 25 +++++++++++++++++-----
 1 file changed, 20 insertions(+), 5 deletions(-)

diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 0bb0c0f..4fd7eda 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -2239,7 +2239,10 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                     CraftEventFactory.handleEditBookEvent(player, itemstack1); // CraftBukkit
                 }
             } catch (Exception exception) {
-                PlayerConnection.LOGGER.error("Couldn\'t handle book info", exception);
+                // PaperDragon start - Import Patch from EMC
+                // PlayerConnection.LOGGER.error("Couldn\'t handle book info", exception);
+                new com.domnian.paperdragon.event.IllegalPacketEvent(player.getBukkitEntity(), "InvalidBookEdit", exception).callEvent();
+                // PaperDragon end
                 this.disconnect("Invalid book data!"); // CraftBukkit
             }
         } else {
@@ -2282,7 +2285,10 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                         CraftEventFactory.handleEditBookEvent(player, itemstack1); // CraftBukkit
                     }
                 } catch (Exception exception1) {
-                    PlayerConnection.LOGGER.error("Couldn\'t sign book", exception1);
+                    // PaperDragon start - Manually Import Patch from EMC
+                    //PlayerConnection.LOGGER.error("Couldn\'t sign book", exception1);
+                    new com.domnian.paperdragon.event.IllegalPacketEvent(player.getBukkitEntity(), "InvalidBookSign", exception1).callEvent();
+                    // PaperDragon end
                     this.disconnect("Invalid book data!"); // CraftBukkit
                 }
             } else if ("MC|TrSel".equals(s)) {
@@ -2294,7 +2300,10 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                         ((ContainerMerchant) container).d(j);
                     }
                 } catch (Exception exception2) {
-                    PlayerConnection.LOGGER.error("Couldn\'t select trade", exception2);
+                    // PaperDragon start - Manually Import Patch from EMC
+                    //PlayerConnection.LOGGER.error("Couldn\'t select trade", exception2);
+                    new com.domnian.paperdragon.event.IllegalPacketEvent(player.getBukkitEntity(), "InvalidTrade", exception2).callEvent();
+                    // PaperDragon end
                     this.disconnect("Invalid trade data!"); // CraftBukkit
                 }
             } else {
@@ -2436,7 +2445,10 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                                     iinventory.update();
                                 }
                             } catch (Exception exception5) {
-                                PlayerConnection.LOGGER.error("Couldn\'t set beacon", exception5);
+                                // PaperDragon start - Manually Import Patch from EMC
+                                //PlayerConnection.LOGGER.error("Couldn\'t set beacon", exception5);
+                                new com.domnian.paperdragon.event.IllegalPacketEvent(player.getBukkitEntity(), "IllegelBeacon", exception5).callEvent();
+                                // PaperDragon end
                                 this.disconnect("Invalid beacon data!"); // CraftBukkit
                             }
                         }
@@ -2536,7 +2548,10 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
                             this.player.playerConnection.sendPacket(new PacketPlayOutSetSlot(-2, k, this.player.inventory.getItem(k)));
                             this.player.playerConnection.sendPacket(new PacketPlayOutHeldItemSlot(this.player.inventory.itemInHandIndex));
                         } catch (Exception exception7) {
-                            PlayerConnection.LOGGER.error("Couldn\'t pick item", exception7);
+                            // PaperDragon start - Manually Import Patch from EMC
+                            //PlayerConnection.LOGGER.error("Couldn\'t pick item", exception7);
+                            new com.domnian.paperdragon.event.IllegalPacketEvent(player.getBukkitEntity(), "InvalidPickItem" ,exception7).callEvent();
+                            // PaperDragon end
                             this.disconnect("Invalid item data!"); // CraftBukkit
                         }
                     }
-- 
2.5.0

