From 5ee9e8da029c5d25f47d38182c6731820dc46f54 Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Thu, 3 May 2018 21:42:07 -0400
Subject: [PATCH] Implement Enhanced Death Event

---
 src/main/java/com/domnian/paperdragon/PDEventFactory.java   | 1 -
 src/main/java/net/minecraft/server/EntityPlayer.java        | 6 +++++-
 .../org/bukkit/craftbukkit/event/CraftEventFactory.java     | 3 ++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/main/java/com/domnian/paperdragon/PDEventFactory.java b/src/main/java/com/domnian/paperdragon/PDEventFactory.java
index b9d2de8b9..ac039615f 100644
--- a/src/main/java/com/domnian/paperdragon/PDEventFactory.java
+++ b/src/main/java/com/domnian/paperdragon/PDEventFactory.java
@@ -5,7 +5,6 @@ import com.domnian.paperdragon.events.ServerShutdownEvent;
 import net.minecraft.server.BlockPosition;
 import net.minecraft.server.Entity;
 import net.minecraft.server.EntityPlayer;
-import org.bukkit.Bukkit;
 import org.bukkit.block.Block;
 import org.bukkit.craftbukkit.CraftWorld;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index e261a777b..0b7d45ae1 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -494,7 +494,11 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         IChatBaseComponent chatmessage = this.getCombatTracker().getDeathMessage();
 
         String deathmessage = chatmessage.toPlainText();
-        org.bukkit.event.entity.PlayerDeathEvent event = CraftEventFactory.callPlayerDeathEvent(this, loot, deathmessage, keepInventory);
+        // PaperDragon start - Enhanced Player Death Event
+        String deathKey = (chatmessage instanceof ChatMessage) ? ((ChatMessage) chatmessage).i() : "death.attack.generic";
+        //org.bukkit.event.entity.PlayerDeathEvent event = CraftEventFactory.callPlayerDeathEvent(this, loot, deathmessage, keepInventory);
+        org.bukkit.event.entity.PlayerDeathEvent event = CraftEventFactory.callPlayerDeathEvent(this, loot, deathmessage, keepInventory, deathKey);
+        // PaperDragon stop
 
         String deathMessage = event.getDeathMessage();
 
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 7db3d0d35..4d599a643 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -406,10 +406,11 @@ public class CraftEventFactory {
         return event;
     }
 
-    public static PlayerDeathEvent callPlayerDeathEvent(EntityPlayer victim, List<org.bukkit.inventory.ItemStack> drops, String deathMessage, boolean keepInventory) {
+    public static PlayerDeathEvent callPlayerDeathEvent(EntityPlayer victim, List<org.bukkit.inventory.ItemStack> drops, String deathMessage, boolean keepInventory, String key) { // PaperDragon - Pass Translation Key to Death Event
         CraftPlayer entity = victim.getBukkitEntity();
         PlayerDeathEvent event = new PlayerDeathEvent(entity, drops, victim.getExpReward(), 0, deathMessage);
         event.setKeepInventory(keepInventory);
+        event.setSourceKey(key);
         org.bukkit.World world = entity.getWorld();
         Bukkit.getServer().getPluginManager().callEvent(event);
 
-- 
2.17.0

