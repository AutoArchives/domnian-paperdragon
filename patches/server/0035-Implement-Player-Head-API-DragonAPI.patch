From 6f422bbebd7e8eaa6bcc56cd97534fdde85b2fd3 Mon Sep 17 00:00:00 2001
From: willies952002 <admin@domnian.com>
Date: Sun, 10 Dec 2017 13:49:00 -0500
Subject: [PATCH] Implement Player Head API (DragonAPI)

---
 .../paperdragon/api/CraftDAPI_Heads.java      | 70 +++++++++++++++++++
 .../paperdragon/api/CraftDragonAPI.java       |  1 +
 2 files changed, 71 insertions(+)
 create mode 100644 src/main/java/com/domnian/paperdragon/api/CraftDAPI_Heads.java

diff --git a/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Heads.java b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Heads.java
new file mode 100644
index 000000000..09a522427
--- /dev/null
+++ b/src/main/java/com/domnian/paperdragon/api/CraftDAPI_Heads.java
@@ -0,0 +1,70 @@
+/*
+ * Copyright (c) 2017. Domnian Development
+ *
+ * This source code is proprietary software and must not be
+ * redistributed without Domnian Development's approval
+ */
+package com.domnian.paperdragon.api;
+
+import co.aikar.timings.NullTimingHandler;
+import co.aikar.timings.Timing;
+import co.aikar.timings.Timings;
+import net.minecraft.server.ItemStack;
+import net.minecraft.server.Items;
+import net.minecraft.server.NBTTagCompound;
+import net.minecraft.server.NBTTagList;
+import org.apache.commons.codec.binary.Base64;
+
+import java.lang.reflect.Method;
+import java.nio.charset.Charset;
+import java.util.UUID;
+
+public class CraftDAPI_Heads implements DAPI_Heads {
+
+    private static final Timing skullCreationTimer = timings();
+
+    /**
+     * Get a Timings Instance to Time Skull Creation
+     * @return a timings instance, else an instance of a {@link co.aikar.timings.NullTimingHandler} on failure
+     */
+    private static Timing timings() {
+        try {
+            Method ofSafeMethod = Timings.class.getMethod("ofSafe", String.class);
+            boolean oldAccessible = ofSafeMethod.isAccessible();
+            ofSafeMethod.setAccessible(true);
+            Object timings = ofSafeMethod.invoke("Skull Creation");
+            ofSafeMethod.setAccessible(oldAccessible);
+            if (timings instanceof Timing) {
+                return (Timing) timings;
+            }
+        } catch (Exception ignored) {}
+        return new NullTimingHandler();
+    }
+
+    @Override
+    public org.bukkit.inventory.ItemStack getSkullFromTexture(String hash) {
+        try (Timing ign = skullCreationTimer.startTimingIfSync()) {
+            String url = "http://textures.minecraft.net/texture/" + hash;
+            ItemStack skull = new ItemStack(Items.SKULL, 1, 3);
+            NBTTagCompound tag = new NBTTagCompound(),
+                    owner = new NBTTagCompound(),
+                    props = new NBTTagCompound(),
+                    textData = new NBTTagCompound();
+            NBTTagList textures = new NBTTagList();
+            owner.setString("Id", UUID.randomUUID().toString());
+            textData.setString("Value", getTextureData(url));
+            textures.add(textData);
+            props.set("textures", textures);
+            owner.set("Properties", props);
+            tag.set("SkullOwner", owner);
+            skull.setTag(tag);
+            return skull.getBukkitStack();
+        }
+    }
+
+    private static String getTextureData(String url) {
+        String texture = "{\"textures\":{\"SKIN\":{\"url\":\"" + url + "\"}}}";
+        return new String(Base64.encodeBase64(texture.getBytes(Charset.forName("UTF-8"))));
+    }
+
+}
diff --git a/src/main/java/com/domnian/paperdragon/api/CraftDragonAPI.java b/src/main/java/com/domnian/paperdragon/api/CraftDragonAPI.java
index 7afe98639..3938f7c25 100644
--- a/src/main/java/com/domnian/paperdragon/api/CraftDragonAPI.java
+++ b/src/main/java/com/domnian/paperdragon/api/CraftDragonAPI.java
@@ -38,6 +38,7 @@ public final class CraftDragonAPI extends DragonAPI {
         meta = new CraftDAPI_Meta();
         attributes = new CraftDAPI_Attributes();
         chat = new CraftDAPI_Chat();
+        heads = new CraftDAPI_Heads();
     }
 
 }
-- 
2.17.0

